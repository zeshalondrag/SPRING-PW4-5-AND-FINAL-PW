<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Панель менеджера - SORATECH</title>
    <link rel="icon" type="image/png" href="/icons/logo.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: "Inter", sans-serif;
            background: #f5f5f5;
            color: #000;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        .admin-container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 340px;
            background: #fff;
            border-right: 2px solid #eaf0f5;
            height: 100vh;
            overflow-y: auto;
            overflow-x: hidden;
            transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
        }

        .sidebar.collapsed {
            width: 80px;
        }

        .sidebar-header {
            border-bottom: 2px solid #eaf0f5;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }

        .sidebar-header .sidebar-logo {
            height: 65px;
            padding: 0 60px;
            transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1), transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sidebar.collapsed .sidebar-header .sidebar-logo {
            opacity: 0;
            transform: translateX(-20px);
            pointer-events: none;
        }

        /* User Info in Sidebar */
        .user-info-sidebar {
            padding: 20px;
            border-bottom: 2px solid #eaf0f5;
            text-align: center;
            transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sidebar.collapsed .user-info-sidebar {
            opacity: 0;
            pointer-events: none;
            height: 0;
            padding: 0;
            overflow: hidden;
        }

        .user-avatar-sidebar {
            width: 65px;
            height: 65px;
            border-radius: 50%;
            background: linear-gradient(135deg, #c5121f 40%, #000 100%);
            margin: 0 auto 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            color: #fff;
            font-weight: 600;
        }

        .user-name-sidebar {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 6px;
        }

        .user-email-sidebar {
            font-size: 13px;
            color: #666;
        }

        .sidebar-toggle {
            position: absolute;
            right: 15px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.3s ease;
            z-index: 10;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sidebar-toggle .hide-icon,
        .sidebar-toggle .show-icon {
            width: 20px;
            height: 20px;
            transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1), transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: absolute;
        }

        .sidebar-toggle .hide-icon {
            opacity: 1;
            transform: scale(1);
        }

        .sidebar-toggle .show-icon {
            opacity: 0;
            transform: scale(0.8);
            pointer-events: none;
        }

        .sidebar.collapsed .sidebar-toggle {
            right: 50%;
            transform: translateX(50%);
        }

        .sidebar.collapsed .sidebar-toggle .hide-icon {
            opacity: 0;
            transform: scale(0.8);
            pointer-events: none;
        }

        .sidebar.collapsed .sidebar-toggle .show-icon {
            opacity: 1;
            transform: scale(1);
            pointer-events: auto;
        }

        .sidebar-nav {
            padding: 0;
            list-style: none;
            flex: 1;
            overflow-y: auto;
        }

        .nav-item {
            padding: 15px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
            display: flex;
            align-items: center;
            gap: 20px;
            text-decoration: none;
            color: #555;
            font-size: 15px;
            font-weight: 500;
            position: relative;
        }

        .nav-item img {
            width: 20px;
            height: 20px;
            min-width: 20px;
            opacity: 0.7;
            transition: all 0.3s ease;
        }

        .nav-item:hover {
            background: #f5f7fa;
            color: #016fff;
        }

        .nav-item:hover img {
            opacity: 1;
            transform: scale(1.1);
        }

        .nav-item.active {
            background: #f5f7fa;
            border-left-color: #c5121f;
            font-weight: 600;
            color: #000;
        }

        .nav-item.active img {
            opacity: 1;
        }

        .nav-item-text {
            transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1), transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            white-space: nowrap;
            overflow: hidden;
        }

        .sidebar.collapsed .nav-item-text {
            opacity: 0;
            transform: translateX(-20px);
            width: 0;
        }

        .sidebar.collapsed .nav-item {
            padding: 15px;
            justify-content: center;
            gap: 0;
        }

        .sidebar.collapsed .nav-item img {
            margin: 0;
        }

        /* Back to Profile Button */
        .back-to-profile {
            padding: 15px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-top: 2px solid #eaf0f5;
            display: flex;
            align-items: center;
            gap: 15px;
            text-decoration: none;
            color: #555;
            font-size: 15px;
            font-weight: 500;
            margin-top: auto;
            background: #fff;
        }

        .back-to-profile img {
            width: 20px;
            height: 20px;
            min-width: 20px;
            opacity: 0.7;
            transition: all 0.3s ease;
        }

        .back-to-profile:hover {
            color: #016fff;
        }

        .back-to-profile:hover img {
            opacity: 1;
        }

        .back-to-profile-text {
            transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1), transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            white-space: nowrap;
            overflow: hidden;
        }

        .sidebar.collapsed .back-to-profile-text {
            opacity: 0;
            transform: translateX(-20px);
            width: 0;
        }

        .sidebar.collapsed .back-to-profile {
            padding: 15px;
            justify-content: center;
            gap: 0;
        }

        .sidebar.collapsed .back-to-profile img {
            margin: 0;
        }

        /* Скроллбар для sidebar */
        .sidebar::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: #f5f7fa;
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 3px;
        }

        .sidebar::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            background: #fff;
            padding: 30px;
            height: 100vh;
            overflow-y: auto;
            overflow-x: hidden;
        }

        /* Скроллбар для main-content */
        .main-content::-webkit-scrollbar {
            width: 8px;
        }

        .main-content::-webkit-scrollbar-track {
            background: #f5f7fa;
        }

        .main-content::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 4px;
        }

        .main-content::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }

        .content-header {
            padding-bottom: 4px;
            border-bottom: 2px solid #eaf0f5;
        }

        .content-header h1 {
            font-size: 28px;
            font-weight: 600;
            color: #333;
        }

        /* Table Container */
        .table-container {
            margin-top: 20px;
        }

        .table-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 15px;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
            max-width: 400px;
        }

        .search-box input {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #eaf0f5;
            border-radius: 4px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
        }

        .search-box input:focus {
            border-color: #016fff;
        }

        .table-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 14px;
        }

        .btn-primary {
            background: #016fff;
            color: #fff;
        }

        .btn-primary:hover {
            background: #005ed6;
        }

        .btn-danger {
            background: #f21827;
            color: #fff;
        }

        .btn-danger:hover {
            background: #c5121f;
        }

        .btn-success {
            background: #28a745;
            color: #fff;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-secondary {
            background: #6c757d;
            color: #fff;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        /* Filters */
        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-size: 13px;
            font-weight: 500;
            color: #555;
        }

        .filter-group select,
        .filter-group input {
            padding: 8px 12px;
            border: 1px solid #eaf0f5;
            border-radius: 4px;
            font-size: 14px;
            outline: none;
            min-width: 150px;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            border-color: #016fff;
        }

        /* Data Table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .data-table thead {
            background: #f5f7fa;
        }

        .data-table th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #555;
            border-bottom: 2px solid #eaf0f5;
            cursor: pointer;
            user-select: none;
        }

        .data-table th:hover {
            background: #e9ecef;
        }

        .data-table th.sortable::after {
            content: " ⇅";
            opacity: 0.3;
        }

        .data-table th.sort-asc::after {
            content: " ↑";
            opacity: 1;
        }

        .data-table th.sort-desc::after {
            content: " ↓";
            opacity: 1;
        }

        .data-table td {
            padding: 12px;
            border-bottom: 1px solid #eaf0f5;
        }

        .data-table tbody tr:hover {
            background: #f5f7fa;
        }

        .data-table .actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s;
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }

        .pagination button {
            padding: 8px 12px;
            border: 1px solid #eaf0f5;
            background: #fff;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .pagination button:hover:not(:disabled) {
            background: #016fff;
            color: #fff;
            border-color: #016fff;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination .page-info {
            padding: 8px 15px;
            font-weight: 600;
            color: #555;
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 40px;
            color: #555;
        }

        .loading::after {
            content: "Загрузка данных...";
            font-size: 18px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            font-size: 20px;
        }

        /* Welcome Screen */
        .welcome-screen {
            text-align: center;
            padding: 100px 20px;
            color: #555;
        }

        .welcome-screen h2 {
            font-size: 32px;
            margin-bottom: 15px;
            color: #016fff;
        }

        .welcome-screen p {
            font-size: 18px;
            color: #777;
        }

        /* Tabs for deleted items */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #eaf0f5;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: #555;
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
        }

        .tab:hover {
            color: #c5121f;
        }

        .tab.active {
            color: #c5121f;
            border-bottom-color: #c5121f;
        }

        /* Checkbox */
        .checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

    </style>
</head>
<body>

    <div class="admin-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <img src="/icons/logo.png" alt="SORATECH" class="sidebar-logo">
                <button class="sidebar-toggle" onclick="toggleSidebar()">
                    <img src="/icons/hide-menu.png" alt="hide menu" class="hide-icon">
                    <img src="/icons/show-menu.png" alt="show menu" class="show-icon">
                </button>
            </div>

            <!-- User Info -->
            <div class="user-info-sidebar">
                <div class="user-avatar-sidebar" th:text="${user.email.substring(0,1).toUpperCase()}">U</div>
                <div class="user-name-sidebar" th:text="${user.name}">Имя пользователя</div>
                <div class="user-email-sidebar" th:text="${user.email}">email@example.com</div>
            </div>

            <nav class="sidebar-nav">
                <a href="#" class="nav-item" data-entity="productdetails">
                    <img src="/icons/compare.png" alt="productdetails">
                    <span class="nav-item-text">Детали товаров</span>
                </a>
                <a href="#" class="nav-item" data-entity="products">
                    <img src="/icons/products.png" alt="products">
                    <span class="nav-item-text">Товары</span>
                </a>
                <a href="#" class="nav-item" data-entity="orders">
                    <img src="/icons/grocery-store.png" alt="orders">
                    <span class="nav-item-text">Заказы</span>
                </a>
                <a href="#" class="nav-item" data-entity="reviews">
                    <img src="/icons/like.png" alt="reviews">
                    <span class="nav-item-text">Отзывы</span>
                </a>
            </nav>

            <!-- Back to Profile -->
            <a href="/profile" class="back-to-profile">
                <img src="/icons/logout.png" alt="back to profile">
                <span class="back-to-profile-text">Вернуться в профиль</span>
            </a>
        </aside>

        <!-- Main Content -->
        <main class="main-content" id="mainContent">
            <div class="content-header">
                <h1 id="pageTitle">Панель менеджера</h1>
            </div>

            <div id="contentArea">
                <div class="welcome-screen">
                    <h2>Добро пожаловать в панель менеджера!</h2>
                    <p>Выберите сущность в меню слева для управления данными</p>
                </div>
            </div>
        </main>
    </div>

    <script>
        let currentEntity = null;
        let currentPage = 0;
        let currentSize = 10;
        let currentSortBy = 'id';
        let currentSortDir = 'asc';
        let currentFilters = {};
        let showDeleted = false;

        // Toggle Sidebar
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('collapsed');
        }

        // Entity Configuration
        const entityConfig = {
            productdetails: {
                title: 'Таблица: Детали товаров',
                endpoint: '/productdetails',
                columns: ['ID', 'Товар', 'Название характеристики', 'Значение характеристики', 'Действия'],
                fields: ['id', 'product.name', 'characteristicName', 'characteristicValue'],
                searchField: 'query'
            },
            products: {
                title: 'Таблица: Товары',
                endpoint: '/products',
                columns: ['ID', 'Название', 'Цена', 'Количество', 'Категория', 'Производитель', 'Действия'],
                fields: ['id', 'name', 'price', 'stockQuantity', 'category.name', 'manufacturer.name'],
                searchField: 'query',
                filters: [
                    { name: 'minPrice', label: 'Мин. цена', type: 'number' },
                    { name: 'maxPrice', label: 'Макс. цена', type: 'number' }
                ]
            },
            orders: {
                title: 'Таблица: Заказы',
                endpoint: '/orders',
                columns: ['ID', 'Пользователь', 'Сумма', 'Статус', 'Дата создания', 'Действия'],
                fields: ['id', 'user.name', 'totalAmount', 'status', 'createdAt'],
                searchField: 'query',
                filters: [
                    { name: 'status', label: 'Статус', type: 'select', options: [
                        { value: '', label: 'Все' },
                        { value: 'PENDING', label: 'В ожидании' },
                        { value: 'CONFIRMED', label: 'Подтвержден' },
                        { value: 'PROCESSING', label: 'В обработке' },
                        { value: 'SHIPPED', label: 'Отправлен' },
                        { value: 'DELIVERED', label: 'Доставлен' },
                        { value: 'CANCELLED', label: 'Отменен' }
                    ]}
                ]
            },
            reviews: {
                title: 'Таблица: Отзывы',
                endpoint: '/reviews',
                columns: ['ID', 'Товар', 'Пользователь', 'Рейтинг', 'Комментарий', 'Дата', 'Действия'],
                fields: ['id', 'product.name', 'user.name', 'rating', 'comment', 'createdAt'],
                searchField: 'query',
                filters: [
                    { name: 'rating', label: 'Рейтинг', type: 'select', options: [
                        { value: '', label: 'Все' },
                        { value: '5', label: '5 звезд' },
                        { value: '4', label: '4 звезды' },
                        { value: '3', label: '3 звезды' },
                        { value: '2', label: '2 звезды' },
                        { value: '1', label: '1 звезда' }
                    ]}
                ]
            }
        };

        // Load Entity Data
        async function loadEntity(entity) {
            currentEntity = entity;
            showDeleted = false;
            currentPage = 0;
            currentFilters = {};
            
            const config = entityConfig[entity];
            document.getElementById('pageTitle').textContent = config.title;
            
            // Update active nav item
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.entity === entity) {
                    item.classList.add('active');
                }
            });
            
            renderTable(config);
            await fetchData();
        }

        // Render Table Structure
        function renderTable(config) {
            const contentArea = document.getElementById('contentArea');
            
            let filtersHTML = '';
            if (config.filters) {
                filtersHTML = '<div class="filters">';
                config.filters.forEach(filter => {
                    filtersHTML += `
                        <div class="filter-group">
                            <label>${filter.label}</label>`;
                    
                    if (filter.type === 'select') {
                        filtersHTML += `<select id="filter-${filter.name}" onchange="applyFilters()">`;
                        filter.options.forEach(opt => {
                            filtersHTML += `<option value="${opt.value}">${opt.label}</option>`;
                        });
                        filtersHTML += `</select>`;
                    } else {
                        filtersHTML += `<input type="${filter.type}" id="filter-${filter.name}" onchange="applyFilters()">`;
                    }
                    
                    filtersHTML += `</div>`;
                });
                filtersHTML += '</div>';
            }
            
            contentArea.innerHTML = `
                <div class="table-container">
                    <div class="tabs">
                        <button class="tab active" onclick="switchTab('active')">Активные</button>
                        <button class="tab" onclick="switchTab('deleted')">Удаленные</button>
                    </div>
                    
                    <div class="table-controls">
                        <div class="search-box">
                            <input type="text" id="searchInput" placeholder="Поиск..." onkeyup="handleSearch()">
                        </div>
                        <div class="table-actions">
                            <button class="btn btn-primary" onclick="createItem()">Добавить запись</button>
                            <button class="btn btn-danger" onclick="deleteSelected()" id="deleteSelectedBtn" style="display:none;">Удалить выбранные</button>
                        </div>
                    </div>
                    
                    ${filtersHTML}
                    
                    <div id="tableContent">
                        <div class="loading"></div>
                    </div>
                    
                    <div class="pagination" id="pagination"></div>
                </div>
            `;
        }

        // Fetch Data from API
        async function fetchData() {
            const config = entityConfig[currentEntity];
            const tableContent = document.getElementById('tableContent');
            tableContent.innerHTML = '<div class="loading"></div>';
            
            try {
                // Build URL with parameters
                let url = `/api/manager/${currentEntity}?page=${currentPage}&size=${currentSize}&sortBy=${currentSortBy}&sortDir=${currentSortDir}&deleted=${showDeleted}`;
                
                // Add search
                const searchValue = document.getElementById('searchInput')?.value;
                if (searchValue) {
                    url += `&${config.searchField}=${encodeURIComponent(searchValue)}`;
                }
                
                // Add filters
                Object.keys(currentFilters).forEach(key => {
                    if (currentFilters[key]) {
                        url += `&${key}=${encodeURIComponent(currentFilters[key])}`;
                    }
                });
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success) {
                    renderTableData(config, data.content);
                    renderPagination(data.currentPage, data.totalPages);
                } else {
                    tableContent.innerHTML = `<div class="empty-state"><h3>Ошибка</h3><p>${data.message}</p></div>`;
                }
                
            } catch (error) {
                console.error('Error fetching data:', error);
                tableContent.innerHTML = '<div class="empty-state"><h3>Ошибка загрузки данных</h3></div>';
            }
        }

        // Render Table Data
        function renderTableData(config, data) {
            const tableContent = document.getElementById('tableContent');
            
            if (!data || data.length === 0) {
                tableContent.innerHTML = `
                    <div class="empty-state">
                        <h3>Нет данных для отображения</h3>
                        <p>Начните с создания новой записи</p>
                    </div>
                `;
                return;
            }
            
            let tableHTML = '<table class="data-table"><thead><tr>';
            tableHTML += '<th><input type="checkbox" class="checkbox" onchange="toggleSelectAll(this)"></th>';
            
            config.columns.forEach((col, index) => {
                if (col !== 'Действия') {
                    const field = config.fields[index];
                    let sortClass = 'sortable';
                    if (currentSortBy === field) {
                        sortClass += currentSortDir === 'asc' ? ' sort-asc' : ' sort-desc';
                    }
                    tableHTML += `<th class="${sortClass}" onclick="sortBy('${field}')">${col}</th>`;
                } else {
                    tableHTML += `<th>${col}</th>`;
                }
            });
            
            tableHTML += '</tr></thead><tbody>';
            
            data.forEach(item => {
                tableHTML += '<tr>';
                tableHTML += `<td><input type="checkbox" class="checkbox row-checkbox" value="${item.id}" onchange="updateDeleteButton()"></td>`;
                
                config.fields.forEach(field => {
                    let value = getNestedValue(item, field);
                    
                    // Format special values
                    if (value === true) value = '✓ Да';
                    if (value === false) value = '✗ Нет';
                    if (field.includes('createdAt') || field.includes('updatedAt')) {
                        value = value ? new Date(value).toLocaleString('ru-RU') : '-';
                    }
                    if (field === 'price' || field === 'totalAmount') {
                        value = value ? `${parseFloat(value).toFixed(2)} ₽` : '-';
                    }
                    
                    tableHTML += `<td>${value || '-'}</td>`;
                });
                
                tableHTML += '<td><div class="actions">';
                tableHTML += `<button class="action-btn edit" onclick="editItem(${item.id})"><img src="/icons/edit.png" alt="edit" style="width: 16px; height: 16px;"></button>`;
                
                if (showDeleted) {
                    tableHTML += `<button class="action-btn restore" onclick="restoreItem(${item.id})"><img src="/icons/restore.png" alt="delete" style="width: 16px; height: 16px;"></button>`;
                    tableHTML += `<button class="action-btn delete" onclick="deleteItem(${item.id}, true)"><img src="/icons/trash.png" alt="delete" style="width: 16px; height: 16px;"></button>`;
                } else {
                    tableHTML += `<button class="action-btn delete" onclick="deleteItem(${item.id}, false)"><img src="/icons/trash.png" alt="delete" style="width: 16px; height: 16px;"></button>`;
                }
                
                tableHTML += '</div></td>';
                tableHTML += '</tr>';
            });
            
            tableHTML += '</tbody></table>';
            tableContent.innerHTML = tableHTML;
        }

        // Helper function to get nested object values
        function getNestedValue(obj, path) {
            return path.split('.').reduce((current, prop) => current?.[prop], obj);
        }

        // Search Handler
        let searchTimeout;
        function handleSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                currentPage = 0;
                fetchData();
            }, 500);
        }

        // Apply Filters
        function applyFilters() {
            const config = entityConfig[currentEntity];
            currentFilters = {};
            
            if (config.filters) {
                config.filters.forEach(filter => {
                    const value = document.getElementById(`filter-${filter.name}`)?.value;
                    if (value) {
                        currentFilters[filter.name] = value;
                    }
                });
            }
            
            currentPage = 0;
            fetchData();
        }

        // Sort By
        function sortBy(field) {
            if (currentSortBy === field) {
                currentSortDir = currentSortDir === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortBy = field;
                currentSortDir = 'asc';
            }
            fetchData();
        }

        // Switch Tab (Active/Deleted)
        function switchTab(tab) {
            showDeleted = tab === 'deleted';
            currentPage = 0;
            
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            fetchData();
        }

        // Pagination
        function renderPagination(currentPage, totalPages) {
            const pagination = document.getElementById('pagination');
            
            let html = `
                <button onclick="goToPage(${currentPage - 1})" ${currentPage === 0 ? 'disabled' : ''}>Предыдущая</button>
                <span class="page-info">Страница ${currentPage + 1} из ${totalPages}</span>
                <button onclick="goToPage(${currentPage + 1})" ${currentPage >= totalPages - 1 ? 'disabled' : ''}>Следующая</button>
            `;
            
            pagination.innerHTML = html;
        }

        function goToPage(page) {
            if (page >= 0) {
                currentPage = page;
                fetchData();
            }
        }

        // CRUD Operations (old methods kept for compatibility)
        function deleteItem(id, permanent) {
            if (confirm(`Вы уверены, что хотите ${permanent ? 'удалить навсегда' : 'удалить'} эту запись?`)) {
                const config = entityConfig[currentEntity];
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = permanent ? `${config.endpoint}/delete/${id}` : `${config.endpoint}/logic-delete/${id}`;
                document.body.appendChild(form);
                form.submit();
            }
        }

        function restoreItem(id) {
            if (confirm('Вы уверены, что хотите восстановить эту запись?')) {
                const config = entityConfig[currentEntity];
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = `${config.endpoint}/restore/${id}`;
                document.body.appendChild(form);
                form.submit();
            }
        }

        function deleteSelected() {
            const checkboxes = document.querySelectorAll('.row-checkbox:checked');
            const ids = Array.from(checkboxes).map(cb => cb.value);
            
            if (ids.length === 0) {
                alert('Выберите элементы для удаления');
                return;
            }
            
            if (confirm(`Вы уверены, что хотите удалить ${ids.length} записей?`)) {
                const config = entityConfig[currentEntity];
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = `${config.endpoint}/delete-multiple`;
                
                ids.forEach(id => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'ids';
                    input.value = id;
                    form.appendChild(input);
                });
                
                const actionInput = document.createElement('input');
                actionInput.type = 'hidden';
                actionInput.name = 'action';
                actionInput.value = 'logic';
                form.appendChild(actionInput);
                
                document.body.appendChild(form);
                form.submit();
            }
        }

        function toggleSelectAll(checkbox) {
            const checkboxes = document.querySelectorAll('.row-checkbox');
            checkboxes.forEach(cb => cb.checked = checkbox.checked);
            updateDeleteButton();
        }

        function updateDeleteButton() {
            const checkboxes = document.querySelectorAll('.row-checkbox:checked');
            const deleteBtn = document.getElementById('deleteSelectedBtn');
            deleteBtn.style.display = checkboxes.length > 0 ? 'block' : 'none';
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Add click handlers to nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const entity = item.dataset.entity;
                    loadEntity(entity);
                });
            });
            
            // Check if there's an initial entity from URL
            const urlParams = new URLSearchParams(window.location.search);
            const initialEntity = urlParams.get('entity');
            if (initialEntity && entityConfig[initialEntity]) {
                // Find and activate the corresponding nav item
                const navItem = document.querySelector(`.nav-item[data-entity="${initialEntity}"]`);
                if (navItem) {
                    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                    navItem.classList.add('active');
                }
                loadEntity(initialEntity);
            }
        });

        // Handle checkbox changes
        document.addEventListener('change', (e) => {
            if (e.target.classList.contains('row-checkbox')) {
                updateDeleteButton();
            }
        });
    </script>

    <!-- Modal Styles -->
    <style>
        .modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }

        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-dialog {
            background: white;
            border-radius: 8px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideIn 0.3s;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 2px solid #eaf0f5;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
        }

        .modal-close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close-btn:hover {
            color: #000;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 20px;
            border-top: 2px solid #eaf0f5;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 14px;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #eaf0f5;
            border-radius: 4px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: #016fff;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-group small {
            display: block;
            margin-top: 5px;
            color: #666;
            font-size: 12px;
        }

        .form-error {
            color: #f21827;
            font-size: 12px;
            margin-top: 5px;
        }

        .confirm-text {
            text-align: center;
            padding: 20px 0;
            font-size: 16px;
            color: #333;
        }

        .confirm-icon {
            text-align: center;
            font-size: 48px;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
    </style>

    <!-- Create/Edit Modal -->
    <div id="crudModal" class="modal">
        <div class="modal-dialog">
            <div class="modal-header">
                <h3 id="modalTitle">Создать</h3>
                <button class="modal-close-btn" onclick="closeModal('crudModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="crudForm">
                    <div id="formFields"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="submitForm()">Сохранить запись</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal('crudModal')">Отмена </button>
            </div>
        </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal">
        <div class="modal-dialog" style="max-width: 400px;">
            <div class="modal-header">
                <h3>Подтверждение удаления</h3>
                <button class="modal-close-btn" onclick="closeModal('deleteModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="confirm-icon"><img src="/icons/warning.png" alt="delete" style="width: 48px; height: 48px;"></div>
                <div class="confirm-text" id="deleteMessage">
                    Вы уверены, что хотите удалить этот элемент?
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" onclick="confirmDelete()">Удалить запись</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal('deleteModal')">Отмена</button>
            </div>
        </div>
    </div>

    <script>
        let currentEditId = null;
        let currentDeleteId = null;
        let currentDeletePermanent = false;

        // Form field configurations for each entity
        const formFieldsConfig = {
            productdetails: [
                { name: 'productId', label: 'Товар', type: 'select', required: true, options: 'products' },
                { name: 'characteristicName', label: 'Название характеристики', type: 'text', required: true, placeholder: 'Цвет, Размер, Вес и т.д.' },
                { name: 'characteristicValue', label: 'Значение характеристики', type: 'text', required: true, placeholder: 'Красный, XL, 1.5 кг и т.д.' }
            ],
            products: [
                { name: 'name', label: 'Название товара', type: 'text', required: true },
                { name: 'price', label: 'Цена', type: 'number', required: true, step: '0.01' },
                { name: 'stockQuantity', label: 'Количество на складе', type: 'number', required: true },
                { name: 'categoryId', label: 'Категория', type: 'select', required: true, options: 'categories' },
                { name: 'manufacturerId', label: 'Производитель', type: 'select', required: true, options: 'manufacturers' }
            ],
            orders: [
                { name: 'userId', label: 'Пользователь', type: 'select', required: true, options: 'users' },
                { name: 'totalAmount', label: 'Общая сумма', type: 'number', required: true, step: '0.01' },
                { name: 'status', label: 'Статус', type: 'select', required: true, options: [
                    { value: 'PENDING', label: 'В ожидании' },
                    { value: 'CONFIRMED', label: 'Подтвержден' },
                    { value: 'PROCESSING', label: 'В обработке' },
                    { value: 'SHIPPED', label: 'Отправлен' },
                    { value: 'DELIVERED', label: 'Доставлен' },
                    { value: 'CANCELLED', label: 'Отменен' }
                ]},
                { name: 'deliveryAddress', label: 'Адрес доставки', type: 'textarea', required: true },
                { name: 'comment', label: 'Комментарий', type: 'textarea' }
            ],
            reviews: [
                { name: 'productId', label: 'Товар', type: 'select', required: true, options: 'products' },
                { name: 'userId', label: 'Пользователь', type: 'select', required: true, options: 'users' },
                { name: 'rating', label: 'Рейтинг', type: 'select', required: true, options: [
                    { value: '5', label: '5 звезд' },
                    { value: '4', label: '4 звезды' },
                    { value: '3', label: '3 звезды' },
                    { value: '2', label: '2 звезды' },
                    { value: '1', label: '1 звезда' }
                ]},
                { name: 'comment', label: 'Комментарий', type: 'textarea', required: true }
            ]
        };

        // Open modal for creating
        function createItem() {
            currentEditId = null;
            document.getElementById('modalTitle').textContent = 'Добавить запись';
            renderFormFields();
            openModal('crudModal');
        }

        // Open modal for editing
        async function editItem(id) {
            currentEditId = id;
            document.getElementById('modalTitle').textContent = 'Редактировать запись';
            renderFormFields();
            
            try {
                const response = await fetch(`/api/manager/${currentEntity}/${id}`);
                if (response.ok) {
                    const data = await response.json();
                    fillFormData(data);
                }
            } catch (error) {
                console.error('Error loading item:', error);
            }
            
            openModal('crudModal');
        }

        // Render form fields based on entity
        function renderFormFields() {
            const fieldsConfig = formFieldsConfig[currentEntity];
            const formFields = document.getElementById('formFields');
            formFields.innerHTML = '';
            
            fieldsConfig.forEach(field => {
                const formGroup = document.createElement('div');
                formGroup.className = 'form-group';
                
                const label = document.createElement('label');
                label.textContent = field.label + (field.required ? ' *' : '');
                label.setAttribute('for', field.name);
                formGroup.appendChild(label);
                
                let input;
                
                if (field.type === 'textarea') {
                    input = document.createElement('textarea');
                } else if (field.type === 'select') {
                    input = document.createElement('select');
                    input.innerHTML = '<option value="">Выберите...</option>';
                    
                    if (Array.isArray(field.options)) {
                        field.options.forEach(opt => {
                            const option = document.createElement('option');
                            option.value = opt.value;
                            option.textContent = opt.label;
                            input.appendChild(option);
                        });
                    } else if (typeof field.options === 'string') {
                        // Load options via AJAX
                        loadSelectOptions(input, field.options);
                    }
                } else if (field.type === 'checkbox') {
                    input = document.createElement('input');
                    input.type = 'checkbox';
                    input.style.width = 'auto';
                } else {
                    input = document.createElement('input');
                    input.type = field.type;
                }
                
                input.id = field.name;
                input.name = field.name;
                if (field.required && field.type !== 'checkbox') input.required = true;
                if (field.placeholder) input.placeholder = field.placeholder;
                if (field.step) input.step = field.step;
                
                formGroup.appendChild(input);
                formFields.appendChild(formGroup);
            });
        }

        // Load select options
        async function loadSelectOptions(selectElement, entityType) {
            try {
                const response = await fetch(`/api/manager/${entityType}?size=1000`);
                if (response.ok) {
                    const data = await response.json();
                    data.content.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item.id;
                        option.textContent = item.name || item.email || item.title;
                        selectElement.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading options:', error);
            }
        }

        // Fill form with data for editing
        function fillFormData(data) {
            const fieldsConfig = formFieldsConfig[currentEntity];
            fieldsConfig.forEach(field => {
                const input = document.getElementById(field.name);
                if (input) {
                    if (field.type === 'checkbox') {
                        input.checked = data[field.name] || false;
                    } else {
                        // Handle nested objects (e.g., category.id -> categoryId)
                        let value = data[field.name];
                        
                        // If value is undefined, try to extract from nested object
                        if (value === undefined && field.name.endsWith('Id')) {
                            const objectName = field.name.replace('Id', '');
                            if (data[objectName] && data[objectName].id) {
                                value = data[objectName].id;
                            }
                        }
                        
                        input.value = value || '';
                    }
                }
            });
        }

        // Submit form
        async function submitForm() {
            const form = document.getElementById('crudForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const formData = new FormData(form);
            const data = {};
            
            formFieldsConfig[currentEntity].forEach(field => {
                const input = document.getElementById(field.name);
                if (input) {
                    if (field.type === 'checkbox') {
                        data[field.name] = input.checked;
                    } else {
                        data[field.name] = input.value;
                    }
                }
            });
            
            try {
                const config = entityConfig[currentEntity];
                const url = currentEditId ? 
                    `${config.endpoint}/edit/${currentEditId}` : 
                    `${config.endpoint}/create`;
                
                const formElement = document.createElement('form');
                formElement.method = 'POST';
                formElement.action = url;
                
                Object.keys(data).forEach(key => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = key;
                    input.value = data[key];
                    formElement.appendChild(input);
                });
                
                document.body.appendChild(formElement);
                formElement.submit();
                
            } catch (error) {
                alert('Ошибка при сохранении: ' + error.message);
            }
        }

        // Show delete confirmation
        function deleteItem(id, permanent) {
            currentDeleteId = id;
            currentDeletePermanent = permanent;
            
            const message = permanent ? 
                'Вы уверены, что хотите удалить этот элемент НАВСЕГДА? Это действие нельзя отменить!' : 
                'Вы уверены, что хотите удалить этот элемент? Его можно будет восстановить позже.';
            
            document.getElementById('deleteMessage').textContent = message;
            openModal('deleteModal');
        }

        // Confirm delete
        function confirmDelete() {
            const config = entityConfig[currentEntity];
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = currentDeletePermanent ? 
                `${config.endpoint}/delete/${currentDeleteId}` : 
                `${config.endpoint}/logic-delete/${currentDeleteId}`;
            
            document.body.appendChild(form);
            form.submit();
        }

        // Restore item
        function restoreItem(id) {
            if (confirm('Вы уверены, что хотите восстановить этот элемент?')) {
                const config = entityConfig[currentEntity];
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = `${config.endpoint}/restore/${id}`;
                document.body.appendChild(form);
                form.submit();
            }
        }

        // Modal functions
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Close modal on outside click
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        }
    </script>

    <!-- Session Timeout Script -->
    <div th:replace="~{fragments/session-timeout :: session-timeout}"></div>
</body>
</html>
